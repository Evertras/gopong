# Network

GoPong's server is authoritative.  The only thing sent from a connected client to the server is input,
which is validated on the server for safety.  State information is sent to clients every update tick on
the server.

Inputs sent have an incrementing index set by the client.  The server will tell each individual client
what the last index seen from them was when sending a state update.  This allows the client to replay
unacknowledged inputs for client side prediction and server reconciliation.

For testing purposes, client side prediction and server reconciliation can be toggled on/off on the front
end.  The back end doesn't care what the front end does in this regard.

## Lag Simulation

The front end uses a simple wrapper around its websocket connection to introduce configurable lag for
testing and development purposes.

## Lobby and Instances

The Go server implements a naive lobby that simply waits for two clients to connect to start a game.
When either client disconnects, the game is over and will no longer run.  Currently there is no limit
to the total number of games that may be played; that's obviously a bad idea for a production game,
but for now it's a TODO to improve the lobby.

Once two clients have connected and been shipped off to a new instance, the lobby will wait for new
clients to connect and continue the process indefinitely.

## Client Connection

To connect, a client must send a GET to `/connect`.  An upgrade request will be sent, and if successful,
messages will begin to flow as described below.

## Web socket protocol

Messages are sent via [Protobuf](https://developers.google.com/protocol-buffers/).  The definitions are
located in [the messages directory](../messages).  One definition is for server-sent messages, the other
is for client-sent messages.

The front end uses [Protobufjs](https://www.npmjs.com/package/protobufjs), and the back end uses
[Go's Protobuf Library](https://github.com/golang/protobuf).  A docker container is used by the Makefile
to generate protobuf definitions for Go so developers and build systems alike don't have to install protoc.
The front end definitions are generated by Protobufjs's included tools of `pbjs` and `pbts`.  See the Makefile
to see how it generates `messages/tsmessage` and `messages/gomessage`.
